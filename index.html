<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gym Tracker">
    <title>Gym Workout Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #6b21a8 50%, #1e293b 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            font-size: 2em;
            margin-bottom: 20px;
            text-align: center;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .btn {
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            width: 100%;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .btn:active {
            opacity: 0.8;
        }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
        }
        .btn-small {
            padding: 8px 15px;
            width: auto;
            font-size: 14px;
            display: inline-block;
            margin: 5px;
        }
        .btn-danger {
            background: #ef4444;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 16px;
            margin-bottom: 10px;
        }
        input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        .exercise-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .flex {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        .hidden {
            display: none;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .set-row {
            display: grid;
            grid-template-columns: 60px 1fr 1fr 40px;
            gap: 10px;
            align-items: center;
            margin-bottom: 8px;
        }
        .category-btn {
            background: rgba(255, 255, 255, 0.2);
            padding: 12px;
            border-radius: 10px;
            border: none;
            color: white;
            cursor: pointer;
            font-weight: 600;
        }
        .category-btn.active {
            background: #8b5cf6;
        }
        .stat-box {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            display: block;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }
        .back-btn {
            color: white;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 20px;
            font-size: 16px;
        }
        .workout-date {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="app"></div>
    </div>

    <script>
        // Data storage
        let state = {
            currentScreen: 'home',
            exercises: {
                chest: ['Bench Press', 'Incline Bench Press', 'Dumbbell Fly', 'Cable Crossover', 'Chest Press Machine'],
                back: ['Deadlift', 'Pull-ups', 'Lat Pulldown', 'Barbell Row', 'Cable Row', 'T-Bar Row'],
                legs: ['Squat', 'Leg Press', 'Leg Extension', 'Leg Curl', 'Calf Raise', 'Lunges'],
                shoulders: ['Overhead Press', 'Lateral Raise', 'Front Raise', 'Rear Delt Fly', 'Shoulder Press Machine'],
                arms: ['Bicep Curl', 'Hammer Curl', 'Tricep Extension', 'Tricep Dips', 'Preacher Curl', 'Skull Crushers'],
                core: ['Plank', 'Crunches', 'Russian Twists', 'Leg Raises', 'Cable Crunch'],
                cardio: ['Outdoor Walk', 'Indoor Walk', 'Spinning', 'Bicycling', 'Running', 'Elliptical']
            },
            workoutLog: [],
            currentWorkout: [],
            selectedCategory: '',
            newExerciseName: '',
            newExerciseCategory: 'chest',
            progressView: null,
            cloud: {
                scriptUrl: '',
                passcode: '',
                signedIn: false,
                status: ''
            }
        };

        // Load data from localStorage
        function loadData() {
            const savedExercises = localStorage.getItem('gym-exercises');
            const savedWorkouts = localStorage.getItem('gym-workouts');
            
            if (savedExercises) {
                state.exercises = JSON.parse(savedExercises);
            }
            if (savedWorkouts) {
                state.workoutLog = JSON.parse(savedWorkouts);
            }
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('gym-exercises', JSON.stringify(state.exercises));
            localStorage.setItem('gym-workouts', JSON.stringify(state.workoutLog));
        }

// ---------------------------
// Cloud Sync (Google Apps Script Web App) - passcode gated
// ---------------------------
// 1) Create an Apps Script Web App (code below in chat) and paste its URL here:
// Example: https://script.google.com/macros/s/AKfycb.../exec
// NOTE: This is convenience security (shared passcode), not strong auth.
function setCloudScriptUrl(url) {
    state.cloud.scriptUrl = (url || '').trim();
    localStorage.setItem('gym-cloud-url', state.cloud.scriptUrl);
}

function loadCloudSettings() {
    const savedUrl = localStorage.getItem('gym-cloud-url');
    const savedSignedIn = localStorage.getItem('gym-cloud-signedin') === '1';
    if (savedUrl) state.cloud.scriptUrl = savedUrl;
    state.cloud.signedIn = savedSignedIn && !!state.cloud.passcode;
}

function setPasscode(passcode) {
    state.cloud.passcode = (passcode || '').trim();
    state.cloud.signedIn = !!state.cloud.passcode;
    localStorage.setItem('gym-cloud-signedin', state.cloud.signedIn ? '1' : '0');
}

// JSONP GET (avoids CORS issues from GitHub Pages)
function cloudJsonp(action, params = {}) {
    return new Promise((resolve, reject) => {
        if (!state.cloud.scriptUrl) return reject(new Error('Missing Script URL'));
        if (!state.cloud.passcode) return reject(new Error('Missing passcode'));

        const cbName = 'cb_' + Math.random().toString(36).slice(2);
        const cleanup = () => {
            delete window[cbName];
            const s = document.getElementById(cbName);
            if (s) s.remove();
        };

        window[cbName] = (data) => {
            cleanup();
            resolve(data);
        };

        const q = new URLSearchParams({
            action,
            passcode: state.cloud.passcode,
            callback: cbName,
            ...params
        });

        const script = document.createElement('script');
        script.id = cbName;
        script.src = state.cloud.scriptUrl + '?' + q.toString();
        script.onerror = () => {
            cleanup();
            reject(new Error('Cloud request failed'));
        };
        document.body.appendChild(script);
    });
}

// Fire-and-forget write (avoids CORS read)
function cloudSendBeacon(action, payloadObj) {
    if (!state.cloud.scriptUrl) throw new Error('Missing Script URL');
    if (!state.cloud.passcode) throw new Error('Missing passcode');
    const body = new URLSearchParams({
        action,
        passcode: state.cloud.passcode,
        payload: JSON.stringify(payloadObj)
    });
    return navigator.sendBeacon(state.cloud.scriptUrl, body);
}

// Merge pulled sessions into local log (by id)
function mergeWorkoutsIntoLocal(incomingWorkouts) {
    const byId = new Map(state.workoutLog.map(w => [String(w.id), w]));
    incomingWorkouts.forEach(w => {
        const key = String(w.id);
        const existing = byId.get(key);
        if (!existing) {
            byId.set(key, w);
        } else {
            // Keep the newer updated_at if present, else keep existing
            const exU = existing.updated_at ? new Date(existing.updated_at).getTime() : 0;
            const inU = w.updated_at ? new Date(w.updated_at).getTime() : 0;
            if (inU > exU) byId.set(key, w);
        }
    });
    state.workoutLog = Array.from(byId.values()).sort((a,b)=> new Date(a.date) - new Date(b.date));
    saveData();
}

async function cloudPull() {
    const res = await cloudJsonp('list');
    if (!res || res.ok !== true) throw new Error((res && res.error) || 'Unknown error');
    mergeWorkoutsIntoLocal(res.workouts || []);
    state.cloud.status = `Pulled ${ (res.workouts||[]).length } session(s) from cloud.`;
    render();
}

function cloudPushAllLocal() {
    if (state.workoutLog.length === 0) {
        state.cloud.status = 'No local workouts to push.';
        render();
        return;
    }
    let okCount = 0;
    state.workoutLog.forEach(w => {
        const sent = cloudSendBeacon('upsert', { workout: w });
        if (sent) okCount++;
    });
    state.cloud.status = `Sent ${okCount} session(s) to cloud (background write). Now tap "Pull from Cloud" to confirm.`;
    render();
}


        // Export backup
        function exportData() {
            const data = {
                exercises: state.exercises,
                workouts: state.workoutLog,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `gym-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('Backup downloaded successfully!');
        }

        // Import backup
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (data.exercises && data.workouts) {
                            if (confirm('This will replace all your current data. Continue?')) {
                                state.exercises = data.exercises;
                                state.workoutLog = data.workouts;
                                saveData();
                                alert('Data imported successfully!');
                                render();
                            }
                        } else {
                            alert('Invalid backup file format.');
                        }
                    } catch (error) {
                        alert('Error reading backup file.');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // Clear all data
        function clearAllData() {
            if (confirm('Are you sure? This will delete ALL your workout data!')) {
                if (confirm('Last chance! Really delete everything?')) {
                    localStorage.clear();
                    state.exercises = {
                        chest: ['Bench Press', 'Incline Bench Press', 'Dumbbell Fly'],
                        back: ['Deadlift', 'Pull-ups', 'Lat Pulldown'],
                        legs: ['Squat', 'Leg Press', 'Leg Extension'],
                        shoulders: ['Overhead Press', 'Lateral Raise'],
                        arms: ['Bicep Curl', 'Tricep Extension'],
                        core: ['Plank', 'Crunches'],
                        cardio: ['Outdoor Walk', 'Running']
                    };
                    state.workoutLog = [];
                    alert('All data cleared.');
                    render();
                }
            }
        }

        // Add exercise to current workout
        function addExerciseToWorkout(exercise, category) {
            const isCardio = category === 'cardio';
            state.currentWorkout.push({
                id: Date.now(),
                name: exercise,
                category: category,
                type: isCardio ? 'cardio' : 'strength',
                sets: isCardio ? [] : [{ weight: '', reps: '' }],
                duration: isCardio ? '' : null,
                distance: isCardio ? '' : null,
                calories: isCardio ? '' : null
            });
            state.selectedCategory = '';
            render();
        }

        // Update exercise set
        function updateExerciseSet(exerciseId, setIndex, field, value) {
            const exercise = state.currentWorkout.find(ex => ex.id === exerciseId);
            if (exercise) {
                exercise.sets[setIndex][field] = value;
            }
        }

        // Update cardio field
        function updateCardioField(exerciseId, field, value) {
            const exercise = state.currentWorkout.find(ex => ex.id === exerciseId);
            if (exercise) {
                exercise[field] = value;
            }
        }

        // Add set
        function addSet(exerciseId) {
            const exercise = state.currentWorkout.find(ex => ex.id === exerciseId);
            if (exercise) {
                exercise.sets.push({ weight: '', reps: '' });
                render();
            }
        }

        // Remove set
        function removeSet(exerciseId, setIndex) {
            const exercise = state.currentWorkout.find(ex => ex.id === exerciseId);
            if (exercise && exercise.sets.length > 1) {
                exercise.sets.splice(setIndex, 1);
                render();
            }
        }

        // Remove exercise from workout
        function removeExerciseFromWorkout(exerciseId) {
            state.currentWorkout = state.currentWorkout.filter(ex => ex.id !== exerciseId);
            render();
        }

        // Save workout
        function saveWorkout() {
            if (state.currentWorkout.length === 0) return;
            
            const nowIso = new Date().toISOString();
            const workout = {
                id: Date.now(),
                date: nowIso,
                updated_at: nowIso,
                exercises: state.currentWorkout
            };
            
            state.workoutLog.push(workout);
            state.currentWorkout = [];
            state.currentScreen = 'home';
            saveData();
            render();
        }

        // Add new exercise
        function addNewExercise() {
            if (!state.newExerciseName.trim()) return;
            
            const category = state.newExerciseCategory;
            state.exercises[category].push(state.newExerciseName.trim());
            state.newExerciseName = '';
            saveData();
            alert('Exercise added successfully!');
            render();
        }

        // Delete exercise
        function deleteExercise(category, exerciseName) {
            if (confirm(`Delete "${exerciseName}"?`)) {
                state.exercises[category] = state.exercises[category].filter(ex => ex !== exerciseName);
                saveData();
                render();
            }
        }

        // Render functions
        function renderHome() {
            const thisWeekCount = state.workoutLog.filter(w => {
                const workoutDate = new Date(w.date);
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                return workoutDate > weekAgo;
            }).length;

            return `
                <h1>üí™ Gym Tracker</h1>
                
                <div class="card">
                    <button class="btn" onclick="navigateTo('log')">‚ûï Log Workout</button>
                    <button class="btn" onclick="navigateTo('progress')">üìà View Progress</button>
                    <button class="btn" onclick="navigateTo('manage')">‚úèÔ∏è Manage Exercises</button>
                    <button class="btn" onclick="navigateTo('history')">üìÖ Workout History</button>
                    <button class="btn" onclick="navigateTo('cloud')">‚òÅÔ∏è Cloud Sync</button>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 15px;">Recent Stats</h3>
                    <div class="grid">
                        <div class="stat-box">
                            <span class="stat-number">${state.workoutLog.length}</span>
                            <span class="stat-label">Total Workouts</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-number">${thisWeekCount}</span>
                            <span class="stat-label">This Week</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 10px;">Backup & Data</h3>
                    <button class="btn btn-secondary" onclick="exportData()">‚¨áÔ∏è Export Backup</button>
                    <button class="btn btn-secondary" onclick="importData()">‚¨ÜÔ∏è Import Backup</button>
                    <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
                </div>

                <div class="card" style="background: rgba(59, 130, 246, 0.2);">
                    <p style="font-size: 0.9em;">üí° <strong>iPhone Tip:</strong> Tap the Share button in Safari and select "Add to Home Screen" to use this app like a native app!</p>
                </div>
            `;
        }

        function renderLog() {
            let html = `
                <a href="#" class="back-btn" onclick="navigateTo('home'); return false;">‚Üê Back to Home</a>
                <h1>Log Workout</h1>
                
                <div class="card">
                    <h3 style="margin-bottom: 15px;">Add Exercise</h3>
                    <div class="grid" style="margin-bottom: 15px;">
            `;

            Object.keys(state.exercises).forEach(category => {
                html += `
                    <button class="category-btn ${state.selectedCategory === category ? 'active' : ''}" 
                            onclick="state.selectedCategory = state.selectedCategory === '${category}' ? '' : '${category}'; render();">
                        ${category.charAt(0).toUpperCase() + category.slice(1)}
                    </button>
                `;
            });

            html += `</div>`;

            if (state.selectedCategory) {
                state.exercises[state.selectedCategory].forEach(exercise => {
                    html += `
                        <button class="btn btn-secondary" 
                                onclick="addExerciseToWorkout('${exercise}', '${state.selectedCategory}')">
                            ${exercise}
                        </button>
                    `;
                });
            }

            html += `</div>`;

            if (state.currentWorkout.length > 0) {
                html += `<div class="card"><h3 style="margin-bottom: 15px;">Current Workout</h3>`;
                
                state.currentWorkout.forEach((exercise, idx) => {
                    html += `
                        <div class="exercise-item">
                            <div class="flex" style="margin-bottom: 10px;">
                                <strong>${exercise.name}</strong>
                                <button class="btn-small btn-danger" onclick="removeExerciseFromWorkout(${exercise.id})">‚úï</button>
                            </div>
                    `;

                    if (exercise.type === 'strength') {
                        exercise.sets.forEach((set, setIdx) => {
                            html += `
                                <div class="set-row">
                                    <span>Set ${setIdx + 1}</span>
                                    <input type="number" placeholder="Weight" value="${set.weight}" 
                                           oninput="updateExerciseSet(${exercise.id}, ${setIdx}, 'weight', this.value)">
                                    <input type="number" placeholder="Reps" value="${set.reps}" 
                                           oninput="updateExerciseSet(${exercise.id}, ${setIdx}, 'reps', this.value)">
                                    ${exercise.sets.length > 1 ? `<button class="btn-small btn-danger" onclick="removeSet(${exercise.id}, ${setIdx})">‚úï</button>` : '<span></span>'}
                                </div>
                            `;
                        });
                        html += `<button class="btn-small btn-secondary" onclick="addSet(${exercise.id})">+ Add Set</button>`;
                    } else {
                        html += `
                            <input type="number" placeholder="Duration (minutes)" value="${exercise.duration}" 
                                   oninput="updateCardioField(${exercise.id}, 'duration', this.value)">
                            <input type="number" placeholder="Distance (miles)" value="${exercise.distance}" 
                                   oninput="updateCardioField(${exercise.id}, 'distance', this.value)">
                            <input type="number" placeholder="Calories" value="${exercise.calories}" 
                                   oninput="updateCardioField(${exercise.id}, 'calories', this.value)">
                        `;
                    }

                    html += `</div>`;
                });

                html += `<button class="btn" onclick="saveWorkout()">üíæ Save Workout</button></div>`;
            }

            return html;
        }

        function renderProgress() {
            if (state.progressView) {
                const isCardio = state.exercises.cardio.includes(state.progressView);
                const workouts = state.workoutLog.filter(w => 
                    w.exercises.some(ex => ex.name === state.progressView)
                ).reverse().slice(0, 10);

                let html = `
                    <a href="#" class="back-btn" onclick="state.progressView = null; render(); return false;">‚Üê Back to Exercise List</a>
                    <h1>${state.progressView}</h1>
                    <div class="card">
                `;

                if (workouts.length === 0) {
                    html += `<p>No data yet for this exercise.</p>`;
                } else {
                    workouts.forEach(workout => {
                        const exercise = workout.exercises.find(ex => ex.name === state.progressView);
                        html += `
                            <div class="exercise-item">
                                <div class="workout-date">${new Date(workout.date).toLocaleDateString()}</div>
                        `;

                        if (isCardio) {
                            if (exercise.duration) html += `<p>Duration: ${exercise.duration} min</p>`;
                            if (exercise.distance) html += `<p>Distance: ${exercise.distance} miles</p>`;
                            if (exercise.calories) html += `<p>Calories: ${exercise.calories}</p>`;
                        } else {
                            const maxWeight = Math.max(...exercise.sets.map(s => parseFloat(s.weight) || 0));
                            const totalVolume = exercise.sets.reduce((sum, s) => 
                                sum + (parseFloat(s.weight) || 0) * (parseInt(s.reps) || 0), 0
                            );
                            html += `
                                <p>Max Weight: ${maxWeight} lbs</p>
                                <p>Total Volume: ${totalVolume} lbs</p>
                                <p>Sets: ${exercise.sets.length}</p>
                            `;
                        }

                        html += `</div>`;
                    });
                }

                html += `</div>`;
                return html;
            }

            // Exercise list
            const allExercises = Object.values(state.exercises).flat();
            const exercisesWithData = allExercises.filter(ex => 
                state.workoutLog.some(w => w.exercises.some(e => e.name === ex))
            );

            let html = `
                <a href="#" class="back-btn" onclick="navigateTo('home'); return false;">‚Üê Back to Home</a>
                <h1>Progress Tracking</h1>
                <div class="card">
                    <h3 style="margin-bottom: 15px;">Select Exercise</h3>
            `;

            if (exercisesWithData.length === 0) {
                html += `<p>No exercise data yet. Start logging workouts!</p>`;
            } else {
                exercisesWithData.forEach(exercise => {
                    html += `
                        <button class="btn btn-secondary" onclick="state.progressView = '${exercise}'; render();">
                            ${exercise} ‚Üí
                        </button>
                    `;
                });
            }

            html += `</div>`;
            return html;
        }

        function renderManage() {
            let html = `
                <a href="#" class="back-btn" onclick="navigateTo('home'); return false;">‚Üê Back to Home</a>
                <h1>Manage Exercises</h1>
                
                <div class="card">
                    <h3 style="margin-bottom: 15px;">Add New Exercise</h3>
                    <input type="text" placeholder="Exercise name" value="${state.newExerciseName}" 
                           oninput="state.newExerciseName = this.value">
                    <select onchange="state.newExerciseCategory = this.value">
            `;

            Object.keys(state.exercises).forEach(cat => {
                html += `<option value="${cat}" ${state.newExerciseCategory === cat ? 'selected' : ''}>
                    ${cat.charAt(0).toUpperCase() + cat.slice(1)}
                </option>`;
            });

            html += `
                    </select>
                    <button class="btn" onclick="addNewExercise()">Add Exercise</button>
                </div>
            `;

            Object.entries(state.exercises).forEach(([category, exercises]) => {
                html += `
                    <div class="card">
                        <h3 style="margin-bottom: 15px; text-transform: capitalize;">${category}</h3>
                `;

                exercises.forEach(exercise => {
                    html += `
                        <div class="exercise-item">
                            <div class="flex">
                                <span>${exercise}</span>
                                <button class="btn-small btn-danger" onclick="deleteExercise('${category}', '${exercise}')">Delete</button>
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
            });

            return html;
        }

        function renderHistory() {
            let html = `
                <a href="#" class="back-btn" onclick="navigateTo('home'); return false;">‚Üê Back to Home</a>
                <h1>Workout History</h1>
            `;

            if (state.workoutLog.length === 0) {
                html += `
                    <div class="card" style="text-align: center; padding: 40px;">
                        <p style="font-size: 1.2em;">No workouts logged yet</p>
                        <p style="opacity: 0.8; margin-top: 10px;">Start tracking your progress today!</p>
                    </div>
                `;
            } else {
                state.workoutLog.slice().reverse().forEach(workout => {
                    html += `
                        <div class="card">
                            <div class="workout-date">
                                ${new Date(workout.date).toLocaleDateString('en-US', { 
                                    weekday: 'long', 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric' 
                                })}
                            </div>
                    `;

                    workout.exercises.forEach(exercise => {
                        html += `
                            <div class="exercise-item">
                                <strong>${exercise.name}</strong><br>
                        `;

                        if (exercise.type === 'strength') {
                            exercise.sets.forEach((set, idx) => {
                                html += `<div style="font-size: 0.9em; opacity: 0.9;">Set ${idx + 1}: ${set.weight} lbs √ó ${set.reps} reps</div>`;
                            });
                        } else {
                            if (exercise.duration) html += `<div style="font-size: 0.9em; opacity: 0.9;">Duration: ${exercise.duration} min</div>`;
                            if (exercise.distance) html += `<div style="font-size: 0.9em; opacity: 0.9;">Distance: ${exercise.distance} miles</div>`;
                            if (exercise.calories) html += `<div style="font-size: 0.9em; opacity: 0.9;">Calories: ${exercise.calories}</div>`;
                        }

                        html += `</div>`;
                    });

                    html += `</div>`;
                });
            }

            
function renderCloud() {
    const urlVal = state.cloud.scriptUrl || '';
    const signedIn = !!state.cloud.passcode;
    return `
        <a href="#" class="back-btn" onclick="navigateTo('home'); return false;">‚Üê Back to Home</a>
        <h1>Cloud Sync</h1>

        <div class="card" style="background: rgba(59, 130, 246, 0.15);">
            <p style="font-size: 0.95em; line-height: 1.35;">
                This sync shares your workouts across devices using a Google Sheet behind a Google Apps Script Web App.
                Access is protected by a shared passcode (simple, not bank-vault security).
            </p>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 10px;">1) Script URL</h3>
            <input type="text" placeholder="Paste your Apps Script Web App URL here" value="${urlVal}"
                   oninput="setCloudScriptUrl(this.value)">
            <div style="font-size: 0.9em; opacity: 0.85;">
                Tip: it ends with <code>/exec</code>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 10px;">2) Passcode</h3>
            <input type="password" placeholder="Enter passcode" value="${state.cloud.passcode || ''}"
                   oninput="setPasscode(this.value)">
            <div style="font-size: 0.9em; opacity: 0.85;">
                Status: ${signedIn ? '‚úÖ Signed in' : '‚ö†Ô∏è Not signed in'}
            </div>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 10px;">Sync Actions</h3>
            <button class="btn" onclick="cloudPull()">‚¨áÔ∏è Pull from Cloud</button>
            <button class="btn btn-secondary" onclick="cloudPushAllLocal()">‚¨ÜÔ∏è Push All Local to Cloud</button>
            <div style="margin-top: 10px; font-size: 0.95em; opacity: 0.9;">
                ${state.cloud.status ? state.cloud.status : ' '}
            </div>
        </div>

        <div class="card" style="background: rgba(236, 72, 153, 0.12);">
            <p style="font-size: 0.9em; line-height: 1.35;">
                Recommended flow on a new device: set Script URL + passcode, then tap <strong>Pull from Cloud</strong>.
            </p>
        </div>
    `;
}

return html;
        }

        // Navigation
        function navigateTo(screen) {
            state.currentScreen = screen;
            state.selectedCategory = '';
            render();
        }

        // Main render function
        function render() {
            const app = document.getElementById('app');
            let content = '';

            switch(state.currentScreen) {
                case 'home':
                    content = renderHome();
                    break;
                case 'log':
                    content = renderLog();
                    break;
                case 'progress':
                    content = renderProgress();
                    break;
                case 'manage':
                    content = renderManage();
                    break;
                case 'history':
                    content = renderHistory();
                    break;
                case 'cloud':
                    content = renderCloud();
                    break;
            }

            app.innerHTML = content;
        }

        // Initialize
        loadData();
        loadCloudSettings();
        render();
    </script>
</body>
</html>
